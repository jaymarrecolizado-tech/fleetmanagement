# LOKA Fleet Management System - State Document
## Date: 2026-01-22
## Persona: LEAD IMPLEMENTATION ENGINEER (MINIMAX M2.1)

---

## PERSONA: LEAD IMPLEMENTATION ENGINEER (MINIMAX M2.1)

**Role:** High-Velocity Builder
**Goal:** Transform requirements into feature-complete, aesthetically stunning, and copy-pasteable production code.

### OPERATIONAL DIRECTIVES:
- **Library-First Strategy:** Always use modern, industry-standard libraries (Shadcn UI, Tailwind, TanStack Query, Zod, Prisma, Lucide) to avoid reinventing the wheel.
- **UI/UX Excellence:** Default to high-fidelity "vibe" coding—modern spacing, hover states, loading skeletons, and responsive layouts.
- **No Snippets:** Provide complete file contents. If a file is modified, provide the entire updated file.
- **Interleaved Logic:** Use `<thinking>` tags to plan the feature breakdown, state management flow, and dependency map before writing code.

### ULTRATHINK / KING MODE:
When "ULTRATHINK" is triggered:
1. **The Roadmap:** Breakdown the request into a 5-step implementation plan.
2. **The Stack:** Explicitly state the chosen libraries and why they are best for this specific task.
3. **The Big Bang:** Generate the Database Schema, the API routes, and the Frontend components in a single, cohesive response.
4. **Error Handling:** Implement basic try-catch blocks and user-facing error messages by default.

---

## PROJECT OVERVIEW

**LOKA Fleet Management System** - A comprehensive fleet management application built with:
- **Backend:** Vanilla PHP 8.0+ with PDO
- **Database:** MySQL/MariaDB
- **Frontend:** Bootstrap 5, Vanilla JavaScript
- **Features:** Role-based access control, two-stage approval workflow, email notifications

### User Roles:
- `requester` - Can create vehicle requests
- `approver` - Department-level approver (can approve requests regardless of department if assigned)
- `motorpool_head` - Motorpool head (can approve motorpool stage regardless of department if assigned)
- `admin` - Full access to all requests

---

## COMPLETED WORK (2026-01-22)

### 1. USERS PAGE FIX
**File:** `pages/users/index.php`
- **Issue:** SQL ambiguity error with `deleted_at` column
- **Fix:** Prefixed columns with table alias `u.deleted_at`, `u.role`, `u.status`, `u.name`, `u.email`

### 2. APPROVAL QUEUE ENHANCEMENTS
**Files:** 
- `pages/approvals/index.php`
- `migrations/007_viewed_at_column.php`

**Changes:**
- Added `viewed_at` column to `requests` table to track viewed status
- Sorted pending requests by: unread first (`viewed_at IS NULL DESC`), then by latest (`created_at DESC`)
- Added "NEW" badge for non-viewed requests
- Added yellow row highlighting for new requests
- Auto-mark requests as viewed when opened in `view.php`

### 3. TWO-STAGE APPROVAL WORKFLOW
**Files:**
- `pages/approvals/process.php` (COMPLETE REWRITE)
- `pages/approvals/view.php`
- `config/constants.php`

**Workflow:**
```
Draft → Pending (Dept) → Pending_Motorpool → Approved
              ↓                ↓                ↓
           Rejected        Rejected         Rejected
              ↓                ↓
        Request Revision  Request Revision
              ↓                ↓
         (Edit & Resubmit) → Pending
```

**Features:**
- Assigned approvers/motorpool heads can process requests REGARDLESS of department
- Three actions: Approve | Request Revision | Reject
- All stakeholders notified at each stage (requester, passengers, driver)

### 4. REQUEST REVISION FEATURE
**New Status:** `STATUS_REVISION` = 'revision'
- Approvers can send requests back for revision with comments
- Requester can edit and resubmit
- Upon resubmission, status resets to `pending` and `viewed_at` cleared

### 5. EMAIL NOTIFICATION SYSTEM
**Files:**
- `config/mail.php` - Email templates
- `classes/Mailer.php` - SMTP mailer
- `classes/EmailQueue.php` - Email queue
- `cron/process_queue.php` - Queue processor

**Notification Flow:**
| Stage | Notified |
|-------|----------|
| Request Submitted | Approver, Requester, Passengers, Requested Driver |
| Department Approved | Requester, Passengers, Motorpool Head, Requested Driver |
| Request Revision | Requester, Passengers, Requested Driver |
| Request Rejected | Requester, Passengers, Requested Driver |
| Fully Approved | Requester, Passengers, Assigned Driver, Requested Driver |

### 6. WORKFLOW VERIFICATION & FIXES
**Files Created:**
- `cron/fix_workflow.php` - Verification and fix script
- `cron/test_email_config.php` - Email configuration tester

**Fixes Applied:**
- Fixed status mismatches (workflow said `approved` but request was `pending_motorpool`)
- Fixed cancellation workflow (now uses `cancelled` status instead of `rejected`)
- Created verification script to catch future issues

---

## CURRENT SYSTEM STATUS

### Request Status Distribution:
| Status | Count | Description |
|--------|-------|-------------|
| Pending | 13 | Awaiting department approval |
| Approved | 3 | Fully approved |
| Rejected | 4 | Rejected by approver |
| Pending_Motorpool | 0 | Awaiting motorpool approval |
| Draft | 0 | Created but not submitted |
| Revision | 0 | Sent back for revision |
| Cancelled | 4 | Cancelled by requester |

### Email Queue Status:
- **Pending:** 29 emails (waiting for email credentials)
- **Sent:** 36 emails

### Email Configuration Required:
**File:** `config/mail.php`

```php
define('MAIL_USERNAME', 'your-email@gmail.com');        // Your Gmail address
define('MAIL_PASSWORD', 'your-16-digit-app-password');  // App Password
define('MAIL_FROM_ADDRESS', 'your-email@gmail.com');    // Must match username
```

**To create App Password:**
1. Go to https://myaccount.google.com/security
2. Enable 2-Step Verification
3. Go to https://myaccount.google.com/apppasswords
4. Create password for "Mail" app

---

## DATABASE SCHEMA

### Tables:
1. `users` - User accounts with roles
2. `requests` - Vehicle requests with status workflow
3. `departments` - Department definitions
4. `vehicles` - Fleet vehicles
5. `drivers` - Drivers
6. `request_passengers` - Passengers on each request
7. `approvals` - Approval records (who approved what)
8. `approval_workflow` - Workflow tracking
9. `notifications` - In-app notifications
10. `email_queue` - Email queue for background sending
11. `audit_logs` - Audit trail
12. `saved_workflows` - Saved workflow configurations

### Request Status Values:
- `draft` - Initial state
- `pending` - Awaiting department approval
- `pending_motorpool` - Awaiting motorpool approval
- `approved` - Fully approved
- `rejected` - Rejected
- `revision` - Sent back for revision
- `cancelled` - Cancelled by requester

---

## KEY FILES REFERENCE

| File | Purpose |
|------|---------|
| `pages/approvals/index.php` | Pending & Processed approval queues |
| `pages/approvals/view.php` | Review request and take action |
| `pages/approvals/process.php` | Handle approval actions |
| `pages/requests/create.php` | Create new request |
| `pages/requests/edit.php` | Edit request (including revision) |
| `pages/requests/view.php` | View request details |
| `pages/requests/cancel.php` | Cancel request |
| `classes/Mailer.php` | SMTP email sender |
| `classes/EmailQueue.php` | Email queue management |
| `config/mail.php` | Email configuration & templates |
| `config/constants.php` | Status values, roles, labels |
| `includes/functions.php` | Helper functions |
| `cron/process_queue.php` | Process email queue |
| `cron/fix_workflow.php` | Verify & fix workflow issues |
| `cron/test_email_config.php` | Test email configuration |

---

## PENDING / KNOWN ISSUES

1. **Email credentials not configured** - 29 pending emails in queue
   - Fix: Update `config/mail.php` with Gmail App Password

2. **Some old requests (2, 3, 6) have no approval records**
   - These were processed before approval tracking was implemented
   - Not critical - workflow verification shows these were cancelled

3. **Cron job setup needed**
   - Need to set up automated email queue processing
   - Windows: Task Scheduler with `process_email_queue.bat`
   - Linux: Cron job `*/2 * * * * php /path/to/cron/process_queue.php`

---

## NEXT STEPS (Suggested)

1. **Configure email** - Add Gmail App Password to `config/mail.php`
2. **Test email** - Run `php cron/test_email_config.php`
3. **Process pending emails** - Run `php cron/process_queue.php`
4. **Set up cron** - Automate email queue processing
5. **Dashboard enhancement** - Add analytics, stats cards
6. **Trip completion** - Mark trips as completed, return vehicles/drivers
7. **Reports** - Export functionality

---

## COMMANDS REFERENCE

### Development:
```bash
# Start development (if using PHP built-in server)
php -S localhost:8000

# Process email queue
php cron/process_queue.php

# Fix workflow issues
php cron/fix_workflow.php

# Test email configuration
php cron/test_email_config.php
```

### Database:
```sql
-- Check request status distribution
SELECT status, COUNT(*) FROM requests WHERE deleted_at IS NULL GROUP BY status;

-- Check email queue
SELECT status, COUNT(*) FROM email_queue GROUP BY status;

-- Check workflow consistency
SELECT r.id, r.status, w.status, w.step 
FROM requests r JOIN approval_workflow w ON r.id = w.request_id
WHERE r.status != w.status;
```

---

## CODING STANDARDS FOLLOWED

1. **No comments** unless explicitly requested
2. **Complete file outputs** - No snippets, full files
3. **Prepared statements** - All queries use PDO with parameter binding
4. **Error handling** - Try-catch blocks with user-facing messages
5. **Audit logging** - All major actions logged
6. **CSRF protection** - Tokens on all forms
7. **XSS prevention** - Output escaping with `e()` function

---

*Document generated: 2026-01-22*
*Persona: LEAD IMPLEMENTATION ENGINEER (MINIMAX M2.1)*

---

## 2026-01-23 - DAILY LOG

### 1. NOTIFICATION SYSTEM DIAGNOSIS & FIX (Completed)

**Issue Reported:** No notifications sent to requester, driver, passenger, approver, motorpool head

**Root Cause:** Email credentials not configured in `config/mail.php`

**Actions Taken:**
- Verified email credentials configured (jelite.demo@gmail.com)
- Processed 29 pending emails (all sent successfully)
- Created `cron/debug_notifications.php` diagnostic tool
- Created `cron/process_email_queue.bat` for Windows Task Scheduler

**Results:**
```
Before: 29 pending, 36 sent
After:  0 pending, 65 sent ✅
```

**Files Modified/Created:**
- `config/mail.php` - Added configuration validation
- `includes/functions.php` - Added debug logging to notification functions
- `cron/debug_notifications.php` - New diagnostic tool
- `cron/process_email_queue.bat` - New batch file for Task Scheduler

### 2. CONTEXT-AWARE STATUS DISPLAY & STAGE STATUS (Completed)

**Issue:** Status display not showing context-aware information for approvers

**Changes Made:**

**A. Upper Right Status Badge (view.php):**
- Shows "Pending Your Approval" when assigned approver views pending request
- Shows "Awaiting Your Approval" when motorpool head views pending_motorpool
- Shows "Awaiting Department Approval" for pending requests
- Shows "Awaiting Motorpool Assignment" for pending_motorpool
- Shows "Fully Approved" / "Rejected" / "Under Revision" as appropriate

**B. Approval Workflow Progress Tracker (view.php):**
- Visual cards showing Department Approval and Motorpool Approval stages
- Each stage displays:
  - Status badge (pending/approved/rejected/revision)
  - Approver name
  - Date/time of action
  - Comments if provided
- Color-coded backgrounds (green for approved, red for rejected, yellow for revision)

**C. Stage Status Column (index.php):**
- Main approval queue now shows status of each stage
- Department stage status with icons (✓ Done, ✗ Rejected, ↻ Revision, - Pending)
- Motorpool stage status visible when request reaches motorpool level
- Added "Pending Actions" badge in upper right header

**Files Modified:**
- `pages/approvals/view.php` - Added context-aware status + workflow tracker
- `pages/approvals/index.php` - Added stage status column + pending count badge

### 3. PAGINATION & REDIRECT AFTER APPROVAL (Completed)

**Issue:** 
- No pagination on pending/processed tables
- After approval, stays on same page instead of going to pending list

**Changes Made:**

**A. Pagination (index.php):**
- Added 10 records per page for both tables
- Separate pagination for pending (`p_pending`) and processed (`p_processed`) tabs
- Shows "Showing X to Y of Z records" info
- Navigation with Previous/Next buttons and page numbers
- Tab links reset to page 1

**B. Redirect After Approval (process.php):**
- After processing any action (approve/reject/revision), redirects to:
  `/?page=approvals&tab=pending&p_pending=1`
- Shows success message on the pending list
- Request automatically moves to "Processed" tab after action

**Files Modified:**
- `pages/approvals/index.php` - Added pagination for both tables
- `pages/approvals/process.php` - Updated redirect to pending tab

### 4. QA HARDENING - CRITICAL SECURITY & CONCURRENCY FIXES (Completed)

Based on QA findings, implemented critical fixes:

#### A. Race Condition Prevention (process.php)
- Added `FOR UPDATE` row-level locking to prevent concurrent approval processing
- Request is locked when fetched, preventing duplicate approvals

```php
$request = db()->fetch(
    "SELECT * FROM requests WHERE id = ? FOR UPDATE",  // ROW LOCK
    [$requestId]
);
```

#### B. Transaction Boundary Fix (process.php)
- Moved ALL notify() calls AFTER db()->commit()
- Prevents orphaned emails when transaction fails
- Notifications only sent on successful commit

#### C. State Machine Validation (process.php)
- Added valid state transitions validation
- Prevents invalid transitions (e.g., approved → pending)

```php
$validTransitions = [
    STATUS_PENDING => [STATUS_PENDING_MOTORPOOL, STATUS_REJECTED, STATUS_REVISION, STATUS_CANCELLED],
    STATUS_PENDING_MOTORPOOL => [STATUS_APPROVED, STATUS_REJECTED, STATUS_REVISION, STATUS_CANCELLED],
    STATUS_REVISION => [STATUS_PENDING, STATUS_CANCELLED],
];
```

#### D. Batch Notification Function (functions.php)
- Created `notifyPassengersBatch()` for efficient bulk notifications
- Single query + batch inserts instead of N+1 queries
- 100 passengers = 1 query instead of 101

```php
function notifyPassengersBatch(int $requestId, string $type, string $title, string $message, ?string $link = null): int
```

#### E. Vehicle/Driver Collision Detection (process.php)
- Added conflict checks before motorpool approval
- Prevents overlapping vehicle/driver assignments
- Validates against existing approved requests

#### F. Admin Override Audit Trail (process.php)
- Logs when admin processes unassigned request
- Records assigned approver vs actual approver
- Required reason for admin override

#### G. Enhanced Cancellation Workflow (cancel.php)
- State machine validation for cancellations
- Releases vehicle/driver when approved request cancelled
- Proper notifications to all parties
- Admin override audit trail
- Cancellation reason tracking

**Files Modified:**
- `pages/approvals/process.php` - Complete rewrite with all security fixes
- `includes/functions.php` - Added notifyPassengersBatch() function
- `pages/requests/cancel.php` - Complete rewrite with security improvements

**Summary of Security Improvements:**
| Issue | Before | After |
|-------|--------|-------|
| Race Conditions | No locking | FOR UPDATE lock |
| Orphaned Emails | Notifications in transaction | Notifications after commit |
| Invalid Transitions | No validation | State machine validation |
| Batch Performance | N+1 queries | Single batch query |
| Admin Override | No audit | Full audit trail |
| Vehicle Conflicts | No check | Collision detection |
| Cancellation | Basic | Full workflow with release |

---

### 5. APPROVAL REDIRECT BUG FIX (Completed)

**Issue:** After approving/rejecting/revision request:
- User sees success toast
- Request disappears from pending tab (status changed)
- User redirected to pending tab (which is now empty for them)
- User cannot see their processed request

**Root Cause:**
1. `process.php` redirected to `tab=pending` instead of `tab=processed`
2. JavaScript showed success toast but didn't redirect user

**Changes Made:**

**A. Backend Redirect Fix (process.php:490):**
```php
// Before:
redirectWith('/?page=approvals&tab=pending&p_pending=1', 'success', $message);

// After:
redirectWith('/?page=approvals&tab=processed&p_processed=1', 'success', $message);
```

**B. Frontend AJAX Redirect (view.php JavaScript):**
```javascript
if (success) {
    showToast(message, 'success');
    // Redirect to processed tab so user can see their action
    setTimeout(() => {
        window.location.href = '<?= APP_URL ?>/?page=approvals&tab=processed&p_processed=1';
    }, 1500);
}
```

**Workflow Impact:**
| Action | Old Behavior | New Behavior |
|--------|--------------|--------------|
| Department approves | Redirects to empty pending tab | Redirects to processed tab (shows approval) |
| Motorpool approves | Redirects to empty pending tab | Redirects to processed tab (shows approval) |
| Reject/Revision | Redirects to pending tab | Redirects to processed tab |

**Files Modified:**
- `pages/approvals/process.php` - Changed redirect from pending to processed
- `pages/approvals/view.php` - Added JavaScript redirect after AJAX success

---

### 6. APPROVAL STATUS NOT UPDATING - CRITICAL BUG FIX (Completed)

**Issue:** Approval form submits but status never changes, no errors in console

**Root Cause:** JavaScript `this.action` collision with form field named "action"

When form buttons had `name="action"`, JavaScript's `this.action` returned the RadioNodeList (form field) instead of the form's action URL, causing:
```
POST http://localhost/fleetManagement/LOKA/[object%20RadioNodeList] 404 (Not Found)
```

**Changes Made:**

**A. Renamed Form Field (view.php):**
```html
<!-- Before -->
<button name="action" value="approve">

<!-- After -->
<button name="approval_action" value="approve">
```

**B. Save Form URL Before FormData (view.php):**
```javascript
const formActionUrl = this.action;  // Save BEFORE creating FormData
const formData = new FormData(this);
fetch(formActionUrl, {...});  // Use saved URL
```

**C. Updated PHP to Read New Field Name (process.php):**
```php
// Before
$action = post('action');

// After
$approvalAction = post('approval_action');
```

**D. Added revisionBtn Variable (view.php):**
```javascript
const revisionBtn = document.getElementById('revisionBtn');
```

**Files Modified:**
- `pages/approvals/view.php` - Renamed field, saved URL, added revisionBtn
- `pages/approvals/process.php` - Updated to use `$approvalAction`
- `config/security.php` - Added jQuery and DataTables to CSP

---

### 7. CSP FIX FOR JQUERY & DATATABLES (Completed)

**Issue:** Content Security Policy blocking external scripts

**Fix (config/security.php):**
```php
// Before:
"script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net",
"style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net",
"connect-src 'self'",

// After:
"script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://code.jquery.com https://cdn.datatables.net",
"style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.datatables.net",
"connect-src 'self' https://cdn.jsdelivr.net",
```

---

### CHANGES SUMMARY

| Bug | Root Cause | Fix |
|-----|------------|-----|
| Approval redirects to wrong tab | Redirected to `tab=pending` | Changed to `tab=processed` |
| Approval status not changing | `this.action` returns form field | Save URL before FormData |
| No JavaScript errors | `name="action"` collides with `this.action` | Renamed to `name="approval_action"` |
| revisionBtn undefined | Variable not declared | Added `const revisionBtn = ...` |
| CSP blocking jQuery/DataTables | CSP too restrictive | Added domains to CSP policy |

---

### CURRENT SYSTEM STATUS

**Request Status Distribution:**
| Status | Count | Description |
|--------|-------|-------------|
| Pending | 1 | Awaiting department approval (Request #22) |
| Approved | 0 | Fully approved |
| Pending_Motorpool | 0 | Awaiting motorpool approval |

**Approval Workflow:**
```
Requester submits → Pending → Department Approve → Pending_Motorpool → Motorpool Approve → Approved
                         ↓                    ↓                       ↓
                      Reject               Reject                  Reject
                         ↓                    ↓                       ↓
                      Revision             Revision                Revision
```

---

### TODO / NEXT STEPS

1. [x] Fix approval redirect
2. [x] Fix approval status update bug
3. [ ] Test full approval workflow (department → motorpool)
4. [ ] Clean up debug logs from process.php
5. [ ] Add unit tests for approval workflow

---

*Document updated: 2026-01-23*
*Persona: LEAD IMPLEMENTATION ENGINEER (MINIMAX M2.1)*